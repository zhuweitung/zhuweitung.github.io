

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://raw.gitmirror.com/zhuweitung/picbed/main/a894a628cfd6b9bb778f156b6efeb26b.png">
  <link rel="icon" href="https://raw.gitmirror.com/zhuweitung/picbed/main/a894a628cfd6b9bb778f156b6efeb26b.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="zhuweitung">
  <meta name="keywords" content="">
  
    <meta name="description" content="RabbitMQ知识学习">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ知识学习">
<meta property="og:url" content="https://blog.kedr.cc/posts/1746580309/index.html">
<meta property="og:site_name" content="个人随笔">
<meta property="og:description" content="RabbitMQ知识学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.gitmirror.com/zhuweitung/picbed/main/9dd87d5ae3efd5bb8c599e0e58be0f5e.png">
<meta property="article:published_time" content="2023-01-13T07:52:21.000Z">
<meta property="article:modified_time" content="2023-12-23T10:24:35.193Z">
<meta property="article:author" content="zhuweitung">
<meta property="article:tag" content="java">
<meta property="article:tag" content="RabbitMQ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.gitmirror.com/zhuweitung/picbed/main/9dd87d5ae3efd5bb8c599e0e58be0f5e.png">
  
  
  
  <title>RabbitMQ知识学习 - 个人随笔</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.kedr.cc","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"always","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#96be66","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"f2550b082b1ec518a726847e5f27e3c4","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Rnyy6d3kzXonmFTiXC2DM2wM-gzGzoHsz","app_key":"ItzHQLPR4iIXylU6VCqf1j4f","server_url":"https://rnyy6d3k.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?f2550b082b1ec518a726847e5f27e3c4";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>个人随笔</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.gitmirror.com/zhuweitung/bing-wallpaper/main/wallpaper/day1_1080.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="RabbitMQ知识学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-01-13 15:52" pubdate>
          2023年1月13日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          27k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          225 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">RabbitMQ知识学习</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="基本介绍"><a class="header-anchor" href="#基本介绍"></a>基本介绍</h3>
<p>消息队列，跨进程的通讯机制，上下游逻辑解耦+物理解耦的消息通信服务</p>
<h4 id="消息队列能做什么"><a class="header-anchor" href="#消息队列能做什么"></a>消息队列能做什么</h4>
<ul>
<li>流量削峰</li>
<li>应用解耦</li>
<li>异步处理</li>
</ul>
<h4 id="消息队列的分类"><a class="header-anchor" href="#消息队列的分类"></a>消息队列的分类</h4>
<ul>
<li>ActiveMQ：
<ul>
<li>优点：单机吞吐量万级，时效性ms级，可用性高，基于从主架构实现高可用，消息可靠性较低概率丢失数据</li>
<li>缺点：官方社区不怎么维护，高吞吐量场景较少使用</li>
</ul>
</li>
<li>Kafka：为大数据而生的消息中间件
<ul>
<li>优点：性能卓越，单机写入TPS约在百万条/秒，吞吐量高，分布式，少数机器宕机不会丢失数据</li>
<li>缺点：单机超过64个队列/分区，负载会发生明显飙高现象；消息失败不支持重试；社区更新较慢</li>
</ul>
</li>
<li>RocketMQ：
<ul>
<li>优点：单机吞吐量十万级，分布式架构，消息可以做到0丢失，扩展性好，支持10亿级别的消息堆积</li>
<li>缺点：支持的客户端语言不多，社区活跃度一般</li>
</ul>
</li>
<li>RabbitMQ：
<ul>
<li>优点：由于erlang语言的高并发特性，性能较好，吞吐量万级，支持多种语言，社区活跃度高</li>
<li>缺点：学习成本较高</li>
</ul>
</li>
</ul>
<h4 id="如何选择"><a class="header-anchor" href="#如何选择"></a>如何选择</h4>
<ul>
<li>kafka适合产生大量数据的互联网服务的数据收集业务，若有日志采集功能，肯定首选kafka</li>
<li>RocketMQ天生为金融互联网领域而生，在阿里双十一已经经历过多次考验</li>
<li>RabbitMQ适合当数据量没有那么大，或者是中小型公司</li>
</ul>
<h4 id="RabbitMQ核心概念"><a class="header-anchor" href="#RabbitMQ核心概念"></a>RabbitMQ核心概念</h4>
<ul>
<li>生产者</li>
<li>交换机</li>
<li>队列</li>
<li>消费者</li>
</ul>
<h4 id="基本工作模式"><a class="header-anchor" href="#基本工作模式"></a>基本工作模式</h4>
<p>各模式的具体说明可以查看<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">官网文档</a></p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/b60c9b4281205f09923f34f7c2c8774f.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="工作原理"><a class="header-anchor" href="#工作原理"></a>工作原理</h4>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/f066641de25968e034fb8616e71179da.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><code>Broker</code>：接收和分发消息的应用，RabbitMQ Server 就是 Message Broker</p>
<p><code>Virtual host</code>：出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个 vhost，每个用户在自己的 vhost 创建 exchange／queue 等</p>
<p><code>Connection</code>：publisher／consumer 和 broker 之间的 TCP 连接</p>
<p><code>Channel</code>：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个 thread 创建单独的 channel 进行通讯，AMQP method 包含了 channel id 帮助客 户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</p>
<p><code>Exchange</code>：message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发 消息到 queue 中去。常用的类型有：direct (point-to-point)，topic (publish-subscribe) and fanout (multicast)</p>
<p><code>Queue</code>：消息最终被送到这里等待 consumer 取走</p>
<p><code>Binding</code>：exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key，Binding 信息被保 存到 exchange 中的查询表中，用于 message 的分发依据</p>
<h3 id="Hello-World"><a class="header-anchor" href="#Hello-World"></a>Hello World</h3>
<p>此为简单模式</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/31502f80f519dadc1a92aa4420ca87c8.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="基本实现示例"><a class="header-anchor" href="#基本实现示例"></a>基本实现示例</h4>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rabbitmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>amqp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>生产者示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 创建连接工厂</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">// 设置连接参数</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;192.168.0.123&quot;</span>);<br>        connectionFactory.setUsername(<span class="hljs-string">&quot;rabbitmq&quot;</span>);<br>        connectionFactory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 创建连接和信道</span><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();) &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 声明队列</span><br><span class="hljs-comment">             * 参数说明：</span><br><span class="hljs-comment">             * 队列名称</span><br><span class="hljs-comment">             * 队列里面的消息是否持久化，默认内存</span><br><span class="hljs-comment">             * 队列是否只允许多个消费者消费，即是否消息共享</span><br><span class="hljs-comment">             * 是否自动删除，最后一个消费者断开连接后删除</span><br><span class="hljs-comment">             * 其他参数</span><br><span class="hljs-comment">             */</span><br>            channel.queueDeclare(QUEUE_NAME, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello rabbitmq&quot;</span>;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 发布消息</span><br><span class="hljs-comment">             * 参数说明：</span><br><span class="hljs-comment">             * 交换机名称</span><br><span class="hljs-comment">             * 路由key</span><br><span class="hljs-comment">             * 其他参数</span><br><span class="hljs-comment">             * 消息体</span><br><span class="hljs-comment">             */</span><br>            channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, QUEUE_NAME, <span class="hljs-literal">null</span>, message.getBytes());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 创建连接工厂</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">connectionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">// 设置连接参数</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;192.168.0.123&quot;</span>);<br>        connectionFactory.setUsername(<span class="hljs-string">&quot;rabbitmq&quot;</span>);<br>        connectionFactory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 创建连接和信道</span><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> connectionFactory.newConnection();<br>             <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();) &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 消费消息</span><br><span class="hljs-comment">             * 参数说明：</span><br><span class="hljs-comment">             * 消费的队列名称</span><br><span class="hljs-comment">             * 消费成功后是否自动应答</span><br><span class="hljs-comment">             * 消息传递时的回调</span><br><span class="hljs-comment">             * 取消消费者时的回调</span><br><span class="hljs-comment">             */</span><br>            channel.basicConsume(QUEUE_NAME, <span class="hljs-literal">true</span>,<br>                    (consumerTag, message) -&gt; &#123;<br>                        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));<br>                    &#125;,<br>                    consumerTag -&gt; &#123;<br>                        System.out.println(consumerTag);<br>                    &#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="整合Spring-Boot示例"><a class="header-anchor" href="#整合Spring-Boot示例"></a>整合Spring Boot示例</h4>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>修改配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-service</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.123</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br><br></code></pre></td></tr></table></figure>
<p>增加配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitConfig</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_QUEUE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;default&quot;</span>;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">defaultQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DEFAULT_QUEUE_NAME);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><span class="hljs-meta">@GetMapping(&quot;helloWorld&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">helloWorld</span><span class="hljs-params">()</span> &#123;<br>    rabbitTemplate.convertAndSend(RabbitConfig.DEFAULT_QUEUE_NAME, <span class="hljs-string">&quot;hello rabbitmq&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RabbitListener(queues = RabbitConfig.DEFAULT_QUEUE_NAME)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> &#123;<br>    <span class="hljs-meta">@RabbitHandler</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consume</span><span class="hljs-params">(String message)</span> &#123;<br>        log.info(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Work-Queues"><a class="header-anchor" href="#Work-Queues"></a>Work Queues</h3>
<p>工作队列模式，又叫任务队列模式，为了解决<strong>多个消费者有序执行密集型</strong>的资源任务</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/95212c18dd26cfd83d6ad5631ec54738.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="公平分发"><a class="header-anchor" href="#公平分发"></a>公平分发</h4>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;work&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.WORK_QUEUE_NAME, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = RabbitConfig.WORK_QUEUE_NAME)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker1</span><span class="hljs-params">(String msg, Channel channel, Message message)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者01-接收到消息：&quot;</span> + msg);<br>    &#125;<br>    <span class="hljs-meta">@RabbitListener(queues = RabbitConfig.WORK_QUEUE_NAME)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker2</span><span class="hljs-params">(String msg, Channel channel, Message message)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者02-接收到消息：&quot;</span> + msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/c9f5ad64a5e1633ef88e993643e28681.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>从结果上看每个消费者消费消息的数据是相等的</p>
<h4 id="消息应答"><a class="header-anchor" href="#消息应答"></a>消息应答</h4>
<p>消费者在接收到消息并且处理该消息之后，告诉 rabbitmq 它已经处理了，rabbitmq 可以把该消息删除了</p>
<h5 id="自动应答"><a class="header-anchor" href="#自动应答"></a>自动应答</h5>
<p>消息发送后立即被认为已经传送成功，这种模式需要在<strong>高吞吐量和数据传输安全性方面做权衡</strong></p>
<p><strong>所以这种模式仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用</strong></p>
<h5 id="手动应答"><a class="header-anchor" href="#手动应答"></a>手动应答</h5>
<ul>
<li>Channel.basicAck(long deliveryTag, boolean multiple)：肯定确认应答
<ul>
<li>multiple：表示批量应答，可以减少网络拥堵</li>
</ul>
</li>
<li>Channel.basicReject(long deliveryTag, boolean requeue)：否定确认应答
<ul>
<li>deliveryTag：拒绝对应的消息</li>
<li>requeue：是否重新入队，false时丢弃或进入死信队列</li>
</ul>
</li>
<li>Channel.basicNack(long deliveryTag, boolean multiple, boolean requeue)：表示己拒绝处理该消息，可以将其丢弃
<ul>
<li>multiple：是否多消息</li>
<li>requeue：拒绝该消费者先前接收未ACK的所有消息</li>
</ul>
</li>
<li>Channel.basicRecover(boolean requeue)：恢复消息到队列
<ul>
<li>requeue：表示消息入队后是否投递给其他消费者，true表示投递给其他消费者，false表示重新投递给自己</li>
</ul>
</li>
</ul>
<h4 id="手动应答示例"><a class="header-anchor" href="#手动应答示例"></a>手动应答示例</h4>
<p>配置文件中修改应答模式为手动应答</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-service</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.123</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment"># 应答模式为手动应答</span><br></code></pre></td></tr></table></figure>
<p>消费者在上面代码的基础上修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = RabbitConfig.WORK_QUEUE_NAME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker1</span><span class="hljs-params">(String msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者01-接收到消息：&quot;</span> + msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="持久化"><a class="header-anchor" href="#持久化"></a>持久化</h4>
<p>队列持久化就是将<code>durable</code>属性设置为true</p>
<p>消息持久化在Spring RabbitMQ中默认就是持久化的</p>
<p>调用convertAndSend发送消息后，在RabbitTemplate中会用<code>convertMessageIfNecessary</code>方法将object转换为<code>MessageProperties</code>对象，而MessageProperties类中消息发送模式默认就是持久化的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MessageDeliveryMode</span> <span class="hljs-variable">DEFAULT_DELIVERY_MODE</span> <span class="hljs-operator">=</span> MessageDeliveryMode.PERSISTENT;<br></code></pre></td></tr></table></figure>
<h4 id="不公平分发"><a class="header-anchor" href="#不公平分发"></a>不公平分发</h4>
<p>让处理速度快的消费者多干活</p>
<p>通过修改消费者的信道的<code>basicQos</code>为1，即为不公平分发</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/13b563f82e4d9f16641e4e70bbf0a5f4.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="预取值"><a class="header-anchor" href="#预取值"></a>预取值</h4>
<p>消费者信道上肯定不止只有一个消息，因此这里就存在一个未确认的消息缓冲区，因此希望开发人员能限制此缓冲区的大小，以避免缓冲区里面无限制的未确认消息问题</p>
<p>这个时候就可以通过使用 <code>channel.basicQos()</code> 方法设置预取值，该值定义通道上允许的未确认消息的最大数量，一旦数量达到配置的数量，RabbitMQ 将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认</p>
<h3 id="Publisher-Confirms"><a class="header-anchor" href="#Publisher-Confirms"></a>Publisher Confirms</h3>
<p>发布确认模式</p>
<p>设置队列持久化和消息持久化后还不能保证消息完全不丢失，必须加上发布确认才能保证生产者发布的消息绝对不丢失</p>
<p>spring中需要修改配置文件开启</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-service</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.123</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment"># 应答模式为手动应答</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment"># 设置发布确认类型</span><br></code></pre></td></tr></table></figure>
<ul>
<li>SIMPLE：同步确认，单次、批量确认通过invoke调用</li>
<li>CORRELATED：发布消息成功到交换器后会触发回调方法</li>
<li>NONE：禁用发布确认模式，是默认值</li>
</ul>
<h4 id="发布确认的策略"><a class="header-anchor" href="#发布确认的策略"></a>发布确认的策略</h4>
<h5 id="单个确认发布"><a class="header-anchor" href="#单个确认发布"></a>单个确认发布</h5>
<p>一种同步确认发布的方式，也就是发一个消息以后只有他被确认发布，后续的才能继续发布</p>
<p>最大的缺点是：发布速度特别慢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TimeInterval</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> DateUtil.timer();<br><span class="hljs-comment">// 单个确认发布</span><br>messageInfos.forEach(messageInfo -&gt; &#123;<br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(UUID.randomUUID().toString());<br>    rabbitTemplate.invoke(operations -&gt; &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.PUBLISHER_CONFIRM_QUEUE_NAME, messageInfo, correlationData);<br>        <span class="hljs-keyword">return</span> rabbitTemplate.waitForConfirms(<span class="hljs-number">5000</span>);<br>    &#125;);<br>&#125;);<br>log.info(<span class="hljs-string">&quot;单个确认发布耗时 &#123;&#125; ms&quot;</span>, timer.intervalRestart()); <span class="hljs-comment">// 单个确认发布耗时 4446 ms</span><br></code></pre></td></tr></table></figure>
<h5 id="批量确认发布"><a class="header-anchor" href="#批量确认发布"></a>批量确认发布</h5>
<p>与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地提高吞吐量，当然这种方式的缺点就是:当发生故障导致发布出现问题时，不知道是哪个消息出现问题了，我们必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息</p>
<p>仍然是同步的，也一样阻塞消息的发布</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 批量确认发布</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; messageInfos.size(); i++) &#123;<br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(UUID.randomUUID().toString());<br>    rabbitTemplate.convertAndSend(RabbitConfig.PUBLISHER_CONFIRM_QUEUE_NAME, messageInfos.get(<span class="hljs-number">0</span>), correlationData);<br>    <span class="hljs-keyword">if</span> ((i % messageInfos.size() == <span class="hljs-number">0</span> || i == messageInfos.size() - <span class="hljs-number">1</span>) &amp;&amp; i != <span class="hljs-number">0</span>) &#123;<br>        rabbitTemplate.invoke(operations -&gt; &#123;<br>            <span class="hljs-keyword">return</span> rabbitTemplate.waitForConfirms(<span class="hljs-number">5000</span>);<br>        &#125;);<br>    &#125;<br>&#125;<br>log.info(<span class="hljs-string">&quot;批量确认发布 &#123;&#125; ms&quot;</span>, timer.intervalRestart()); <span class="hljs-comment">// 批量确认发布 1038 ms</span><br></code></pre></td></tr></table></figure>
<h5 id="异步确认发布"><a class="header-anchor" href="#异步确认发布"></a>异步确认发布</h5>
<p>异步确认虽然编程逻辑比上两个要复杂，但是性价比最高，无论是可靠性还是效率都没得说，他是利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 设置异步确认回调函数</span><br>rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123;<br>    <span class="hljs-keyword">if</span> (!ack) &#123;<br>        log.warn(<span class="hljs-string">&quot;id=&#123;&#125; 消息未确认，cause=&#123;&#125;&quot;</span>, correlationData.getId(), cause);<br>        <span class="hljs-comment">// todo 投递异常处理</span><br>    &#125;<br>&#125;);<br>messageInfos.forEach(messageInfo -&gt; &#123;<br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(UUID.randomUUID().toString());<br>    rabbitTemplate.convertAndSend(RabbitConfig.PUBLISHER_CONFIRM_QUEUE_NAME, messageInfo, correlationData);<br>&#125;);<br>log.info(<span class="hljs-string">&quot;异步确认发布 &#123;&#125; ms&quot;</span>, timer.intervalRestart()); <span class="hljs-comment">// 异步确认发布 710 ms</span><br></code></pre></td></tr></table></figure>
<h3 id="交换机"><a class="header-anchor" href="#交换机"></a>交换机</h3>
<p>RabbitMQ 消息传递模型的核心思想是: 生产者生产的消息从不会直接发送到队列</p>
<p>相反，<strong>生产者只能将消息发送到交换机(exchange)</strong>，交换机工作的内容非常简单，一方面它接收来自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。</p>
<p>总共有以下类型：</p>
<ul>
<li>直接（direct）：处理路由键；需要将一个队列绑定到交换机上，要求该消息与一个特定的路由键完全匹配</li>
<li>主题（topic）：将路由键和某模式进行匹配；此时队列需要绑定要一个模式上</li>
<li>标题（headers）：不处理路由键；而是根据发送的消息内容中的headers属性进行匹配</li>
<li>扇出（fanout）：不处理路由键；只需要简单的将队列绑定到交换机上</li>
</ul>
<h4 id="Fanout交换机示例"><a class="header-anchor" href="#Fanout交换机示例"></a>Fanout交换机示例</h4>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/bc2c52cc3bbf1a42be4137ed27105895.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><strong>Publish/Subscribe 发布、订阅模式使用扇出交换机实现</strong></p>
<p>配置类中注册交换机和对应的队列，并进行绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutExchangeConfig</span> &#123;<br>    <span class="hljs-meta">@Bean(name = &quot;fanoutExchange&quot;)</span><br>    <span class="hljs-keyword">public</span> Exchange <span class="hljs-title function_">fanoutExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(FANOUT_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(name = &quot;fanoutQueue1&quot;)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(FANOUT_QUEUE_1);<br>    &#125;<br>    <span class="hljs-meta">@Bean(name = &quot;fanoutQueue2&quot;)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">fanoutQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(FANOUT_QUEUE_2);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">fanoutQueue1Binding</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;fanoutExchange&quot;)</span> FanoutExchange fanoutExchange,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@Qualifier(&quot;fanoutQueue1&quot;)</span> Queue fanoutQueue1)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">fanoutQueue2Binding</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;fanoutExchange&quot;)</span> FanoutExchange fanoutExchange,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@Qualifier(&quot;fanoutQueue2&quot;)</span> Queue fanoutQueue2)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>通过交换机发送</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;fanout&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">fanout</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.FANOUT_EXCHANGE, <span class="hljs-literal">null</span>, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>两个消费者监听两个队列能获取到一样的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = RabbitConfig.FANOUT_QUEUE_1)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker4</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者04-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">@RabbitListener(queues = RabbitConfig.FANOUT_QUEUE_2)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker5</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者05-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="Direct交换机示例"><a class="header-anchor" href="#Direct交换机示例"></a>Direct交换机示例</h4>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/6448b0196934f63c01f941178ca1aa69.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><strong>Routing 路由模式使用直接交换机实现</strong></p>
<p>注册交换机和队列，并进行绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectExchangeConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">directExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DIRECT_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(name = &quot;directQueue1&quot;)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">directQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DIRECT_QUEUE_1);<br>    &#125;<br>    <span class="hljs-meta">@Bean(name = &quot;directQueue2&quot;)</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">directQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DIRECT_QUEUE_2);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">directQueue1Binding</span><span class="hljs-params">(DirectExchange directExchange,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@Qualifier(&quot;directQueue1&quot;)</span> Queue directQueue1)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(directQueue1).to(directExchange).with(DIRECT_QUEUE_1);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">directQueue2Binding</span><span class="hljs-params">(DirectExchange directExchange,</span><br><span class="hljs-params">                                       <span class="hljs-meta">@Qualifier(&quot;directQueue2&quot;)</span> Queue directQueue2)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(directQueue2).to(directExchange).with(DIRECT_QUEUE_2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;direct&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">direct</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>            rabbitTemplate.convertAndSend(RabbitConfig.DIRECT_EXCHANGE, RabbitConfig.DIRECT_QUEUE_2, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            rabbitTemplate.convertAndSend(RabbitConfig.DIRECT_EXCHANGE, RabbitConfig.DIRECT_QUEUE_1, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者代码没什么区别就不放了</p>
<h4 id="Topic交换机示例"><a class="header-anchor" href="#Topic交换机示例"></a>Topic交换机示例</h4>
<p>topic的路由键不能随便写，必须满足一定的规则，它必须是一个单词列表，多个单词用<code>.</code>隔开，单词列表不能超过255个字节，如&quot;<a target="_blank" rel="noopener" href="http://app.log.info">app.log.info</a>&quot;、“*.log.*”、“#.log.*”</p>
<p>其中<code>*</code>可以代替任意一个单词</p>
<p><code>#</code>可以代替零个或多个单词</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/acf93f3d66c9cb21dc0df8444a522115.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><strong>Topics 主题模式使用主题交换机实现</strong></p>
<p>增加交换机和队列注册，并进行绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicExchangeConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title function_">topicExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicExchange</span>(TOPIC_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">topicQueue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousQueue</span>();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">topicQueue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousQueue</span>();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">topicQueue3</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousQueue</span>();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">topicBinding1</span><span class="hljs-params">(TopicExchange topicExchange,</span><br><span class="hljs-params">                                 Queue topicQueue1)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueue1)<br>                .to(topicExchange)<br>                .with(<span class="hljs-string">&quot;*.orange.*&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">topicBinding2</span><span class="hljs-params">(TopicExchange topicExchange,</span><br><span class="hljs-params">                                 Queue topicQueue2)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueue2)<br>                .to(topicExchange)<br>                .with(<span class="hljs-string">&quot;*.*.rabbit&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">topicBinding3</span><span class="hljs-params">(TopicExchange topicExchange,</span><br><span class="hljs-params">                                 Queue topicQueue3)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueue3)<br>                .to(topicExchange)<br>                .with(<span class="hljs-string">&quot;lazy.#&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;topic&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">topic</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> String[] keys = &#123;<span class="hljs-string">&quot;quick.orange.rabbit&quot;</span>, <span class="hljs-string">&quot;lazy.orange.elephant&quot;</span>, <span class="hljs-string">&quot;quick.orange.fox&quot;</span>,<br>            <span class="hljs-string">&quot;lazy.brown.fox&quot;</span>, <span class="hljs-string">&quot;lazy.pink.rabbit&quot;</span>, <span class="hljs-string">&quot;quick.brown.fox&quot;</span>&#125;;<br>    <span class="hljs-keyword">for</span> (String key : keys) &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.TOPIC_EXCHANGE, key, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;#&#123;topicQueue1.name&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker8</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者08-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">@RabbitListener(queues = &quot;#&#123;topicQueue2.name&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker9</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者09-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">@RabbitListener(queues = &quot;#&#123;topicQueue3.name&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker10</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者10-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="死信队列"><a class="header-anchor" href="#死信队列"></a>死信队列</h3>
<p>由于某些原因队列中的一些消息无法被消费，这些消息被称为死信，存放死信的队列被称为死信队列</p>
<p>应用场景：为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息消费发生异常时，将消息投入死信队列中</p>
<h4 id="死信的来源"><a class="header-anchor" href="#死信的来源"></a>死信的来源</h4>
<ul>
<li>消息TTL过期</li>
<li>队列达到最大长度</li>
<li>消息被拒绝：basic.reject、basic.nack方法中requeue=false</li>
</ul>
<h4 id="基础架构"><a class="header-anchor" href="#基础架构"></a>基础架构</h4>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/c735116c3bbaddc2b02a9b494909e075.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="示例"><a class="header-anchor" href="#示例"></a>示例</h4>
<p>注册交换机和队列，并为队列声明死信交换机及绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadQueueConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">normalExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(NORMAL_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">deadExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DEAD_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">normalQueue</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">4</span>);<br>        <span class="hljs-comment">// 声明死信交换机</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);<br>        <span class="hljs-comment">// 声明死信路由键</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_QUEUE);<br>        <span class="hljs-comment">// 声明队列长度</span><br>        args.put(<span class="hljs-string">&quot;x-max-length&quot;</span>, <span class="hljs-number">5</span>);<br>        <span class="hljs-comment">// 声明队列TTL</span><br>        args.put(<span class="hljs-string">&quot;x-message-ttl&quot;</span>, TimeUnit.SECONDS.toMillis(<span class="hljs-number">10</span>));<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(NORMAL_QUEUE).withArguments(args).build();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DEAD_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">normalBinding</span><span class="hljs-params">(DirectExchange normalExchange,</span><br><span class="hljs-params">                                 Queue normalQueue)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(normalQueue)<br>                .to(normalExchange).with(NORMAL_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">deadBinding</span><span class="hljs-params">(DirectExchange deadExchange,</span><br><span class="hljs-params">                                 Queue deadQueue)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadQueue)<br>                .to(deadExchange).with(DEAD_QUEUE);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其余队列声明参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>x-message-ttl</td>
<td>发送到队列的消息在丢弃之前可以存活多长时间（毫秒）</td>
</tr>
<tr>
<td>x-max-length</td>
<td>队列最大长度</td>
</tr>
<tr>
<td>x-expires</td>
<td>队列在被自动删除（毫秒）之前可以使用多长时间</td>
</tr>
<tr>
<td>x-max-length-bytes</td>
<td>队列在开始从头部删除之前可以包含的就绪消息的总体大小</td>
</tr>
<tr>
<td>x-dead-letter-exchange</td>
<td>设置队列溢出行为。这决定了在达到队列的最大长度时消息会发生什么。有效值为drop-head或reject-publish。交换的可选名称，如果消息被拒绝或过期，将重新发布这些名称</td>
</tr>
<tr>
<td>x-dead-letter-routing-key</td>
<td>可选的替换路由密钥，用于在消息以字母为单位时使用。如果未设置，将使用消息的原始路由密钥</td>
</tr>
<tr>
<td>x-max-priority</td>
<td>队列支持的最大优先级数；如果未设置，队列将不支持消息优先级</td>
</tr>
<tr>
<td>x-queue-mode</td>
<td>将队列设置为延迟模式，在磁盘上保留尽可能多的消息以减少内存使用;如果未设置，队列将保留内存缓存以尽快传递消息</td>
</tr>
<tr>
<td>x-queue-master-locator</td>
<td>将队列设置为主位置模式，确定在节点集群上声明时队列主机所在的规则</td>
</tr>
<tr>
<td>x-overflow</td>
<td>队列达到最大长度时，可选模式包括： drop-head, reject-publish 和 reject-publish-dlx.</td>
</tr>
</tbody>
</table>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;deadQueue&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">deadQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.NORMAL_EXCHANGE, RabbitConfig.NORMAL_QUEUE, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="延迟队列"><a class="header-anchor" href="#延迟队列"></a>延迟队列</h3>
<p>延迟队列内部是有序的，最重要的特性就是延时，延时队列达到的目的是在指定时间之后进行消费操作</p>
<p>其实就是死信队列中消息TTL过期那种情况</p>
<h4 id="使用场景"><a class="header-anchor" href="#使用场景"></a>使用场景</h4>
<ul>
<li>订单在十分钟之内未支付则自动取消</li>
<li>新创建的店铺，若在十天内都没有上传过商品，则自动发送消息提醒</li>
<li>用户注册成功后，若三天内没有登录则进行短信提醒</li>
<li>用户发起退款，若三天内没有处理则通知相关运营人员</li>
<li>预定会议后，在预定的时间点前十分钟提醒各参会人员</li>
<li>…</li>
</ul>
<h4 id="示例-v2"><a class="header-anchor" href="#示例-v2"></a>示例</h4>
<p>注册交换机和队列，并绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayQueueConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">delayNormalExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DELAY_NORMAL_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">delayExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(DELAY_EXCHANGE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">delayNormalQueue</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">4</span>);<br>        <span class="hljs-comment">// 声明死信交换机</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DELAY_EXCHANGE);<br>        <span class="hljs-comment">// 声明死信路由键</span><br>        args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DELAY_QUEUE);<br>        <span class="hljs-comment">// 声明队列TTL 延迟40s</span><br>        args.put(<span class="hljs-string">&quot;x-message-ttl&quot;</span>, TimeUnit.SECONDS.toMillis(<span class="hljs-number">40</span>));<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(DELAY_NORMAL_QUEUE).withArguments(args).build();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">delayQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DELAY_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">delayNormalBinding</span><span class="hljs-params">(DirectExchange delayNormalExchange,</span><br><span class="hljs-params">                                 Queue delayNormalQueue)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(delayNormalQueue)<br>                .to(delayNormalExchange).with(DELAY_NORMAL_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">delayBinding</span><span class="hljs-params">(DirectExchange delayExchange,</span><br><span class="hljs-params">                               Queue delayQueue)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(delayQueue)<br>                .to(delayExchange).with(DELAY_QUEUE);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;delayQueue&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">delayQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.DELAY_NORMAL_EXCHANGE, RabbitConfig.DELAY_NORMAL_QUEUE, RandomUtil.randomString(<span class="hljs-number">8</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = RabbitConfig.DELAY_QUEUE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker11</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者11-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="延迟队列优化"><a class="header-anchor" href="#延迟队列优化"></a>延迟队列优化</h4>
<p>上面代码实现的延迟队列的延迟时间是固定的，当需要另一个延迟时间时就又需要再声明一个队列，很麻烦</p>
<p>可以优化为队列不声明延迟时间，延迟时间由生产者确定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">delayDynamicNormalQueue</span><span class="hljs-params">()</span> &#123;<br>    Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">4</span>);<br>    <span class="hljs-comment">// 声明死信交换机</span><br>    args.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, DELAY_EXCHANGE);<br>    <span class="hljs-comment">// 声明死信路由键</span><br>    args.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, DELAY_QUEUE);<br>    <span class="hljs-keyword">return</span> QueueBuilder.durable(DELAY_DYNAMIC_NORMAL_QUEUE).withArguments(args).build();<br>&#125;<br><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">delayDynamicNormalBinding</span><span class="hljs-params">(DirectExchange delayNormalExchange,</span><br><span class="hljs-params">                                  Queue delayDynamicNormalQueue)</span> &#123;<br>    <span class="hljs-keyword">return</span> BindingBuilder.bind(delayDynamicNormalQueue)<br>            .to(delayNormalExchange).with(DELAY_DYNAMIC_NORMAL_QUEUE);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;delayDynamicQueue&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">delayDynamicQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        rabbitTemplate.convertAndSend(RabbitConfig.DELAY_NORMAL_EXCHANGE, RabbitConfig.DELAY_DYNAMIC_NORMAL_QUEUE,<br>                RandomUtil.randomString(<span class="hljs-number">8</span>), message -&gt; &#123;<br>                    <span class="hljs-comment">// 设置延迟时间</span><br>                    message.getMessageProperties().setExpiration(<span class="hljs-string">&quot;10000&quot;</span>);<br>                    <span class="hljs-keyword">return</span> message;<br>                &#125;);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="存在问题"><a class="header-anchor" href="#存在问题"></a>存在问题</h4>
<p>若生产者发送的消息设置不同的延迟时间，依旧是按顺序消费</p>
<p>如第一个消息的延时时间很长，第二个消息的延时时间很短，第二个消息并不会优先得到执行</p>
<p><strong>因为RabbitMQ执行检查第一个消息是否过期</strong></p>
<h4 id="使用插件实现延迟队列"><a class="header-anchor" href="#使用插件实现延迟队列"></a>使用插件实现延迟队列</h4>
<p>基于上面的问题，可以通过安装<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">插件</a>来实现，延迟队列插件是<code>rabbitmq_delayed_message_exchange</code></p>
<p>去<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">rabbitmq/rabbitmq-delayed-message-exchange:</a>下载插件的ez包</p>
<p>使用以下命令启用插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看插件目录</span><br>rabbitmq-plugins directories -s<br><span class="hljs-comment"># 将下载的插件复制到插件目录下</span><br><span class="hljs-built_in">cp</span> rabbitmq_delayed_message_exchange-3.8.0.ez /opt/rabbitmq/plugins<br><span class="hljs-comment"># 启用插件</span><br>rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_delayed_message_exchange<br></code></pre></td></tr></table></figure>
<p>插件安装后多一个<code>x-delayed-message</code>交换机类型</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/c37306f951261145b1e74df22245e7a9.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h5 id="示例代码"><a class="header-anchor" href="#示例代码"></a>示例代码</h5>
<p>注册交换机和队列，并绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title function_">xDelayedMessageExchange</span><span class="hljs-params">()</span> &#123;<br>    Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-comment">// 设置延迟类型</span><br>    args.put(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomExchange</span>(X_DELAYED_MESSAGE_EXCHANGE, <span class="hljs-string">&quot;x-delayed-message&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, args);<br>&#125;<br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">xDelayedMessageQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(X_DELAYED_MESSAGE_QUEUE);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;xDelayedMessageExchange&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">xDelayedMessageExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">expiration</span> <span class="hljs-operator">=</span> i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? <span class="hljs-number">10000</span> : <span class="hljs-number">5000</span>;<br>        rabbitTemplate.convertAndSend(RabbitConfig.X_DELAYED_MESSAGE_EXCHANGE, RabbitConfig.X_DELAYED_MESSAGE_QUEUE,<br>                expiration.toString(), message -&gt; &#123;<br>                    <span class="hljs-comment">// 设置延迟时间</span><br>                    message.getMessageProperties().setDelay(expiration);<br>                    <span class="hljs-keyword">return</span> message;<br>                &#125;);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = RabbitConfig.X_DELAYED_MESSAGE_QUEUE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">worker12</span><span class="hljs-params">(MessageInfo msg, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deliveryTag</span> <span class="hljs-operator">=</span> message.getMessageProperties().getDeliveryTag();<br>    <span class="hljs-keyword">try</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者12-接收到消息：&#123;&#125;&quot;</span>, msg);<br>        channel.basicAck(deliveryTag, <span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.basicNack(deliveryTag, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioException) &#123;<br>            ioException.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="发布确认高级"><a class="header-anchor" href="#发布确认高级"></a>发布确认高级</h3>
<p>生成者发消息给Broker时，若RabbitMQ服务不可用（交换机不可用）或者队列不可用，需要将发送的消息缓存下来，避免消息丢失</p>
<h4 id="发布确认"><a class="header-anchor" href="#发布确认"></a>发布确认</h4>
<p>首先在配置文件中开启发布确认</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-service</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.123</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment"># 应答模式为手动应答</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span><br></code></pre></td></tr></table></figure>
<p>发布确认 确认的是交换机能否收到</p>
<p>实现确认回调，并注入到rabbitTemplate中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        rabbitTemplate.setConfirmCallback(<span class="hljs-built_in">this</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机确认回调方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> correlationData != <span class="hljs-literal">null</span> ? correlationData.getId() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (!ack) &#123;<br>            log.warn(<span class="hljs-string">&quot;&#123;&#125; 消息确认失败, cause=&#123;&#125;&quot;</span>, dataId, cause);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>注册交换机和队列，并绑定</p>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;publisherConfirmPlus&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">publisherConfirmPlus</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(UUID.randomUUID().toString());<br>    rabbitTemplate.convertAndSend(RabbitConfig.PUBLISHER_CONFIRM_PLUS_EXCHANGE + <span class="hljs-string">&quot;_1&quot;</span>,<br>            RabbitConfig.PUBLISHER_CONFIRM_PLUS_QUEUE, RandomUtil.randomString(<span class="hljs-number">8</span>), correlationData);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当交换机ack为false时表示交换机异常，如使用错误的交换机名会报下面的异常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs log">o.s.a.r.c.CachingConnectionFactory       : Shutdown Signal: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange &#x27;publisher_confirm_plus_exchange_1&#x27; in vhost &#x27;/&#x27;, class-id=60, method-id=40)<br></code></pre></td></tr></table></figure>
<h4 id="回退消息"><a class="header-anchor" href="#回退消息"></a>回退消息</h4>
<p>退回消息确认的是队列能否收到</p>
<p>修改配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">rabbitmq-service</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.123</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">rabbitmq</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment"># 应答模式为手动应答</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p>MyCallback类再实现<code>RabbitTemplate.ReturnsCallback</code>接口，并注入到rabbitTemplate中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnsCallbac<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        rabbitTemplate.setConfirmCallback(<span class="hljs-built_in">this</span>);<br>        rabbitTemplate.setReturnsCallback(<span class="hljs-built_in">this</span>);<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机确认回调方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-type">boolean</span> ack, String cause)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> correlationData != <span class="hljs-literal">null</span> ? correlationData.getId() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (!ack) &#123;<br>            log.warn(<span class="hljs-string">&quot;&#123;&#125; 消息确认失败, cause=&#123;&#125;&quot;</span>, dataId, cause);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 队列确认回调方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(ReturnedMessage returned)</span> &#123;<br>        log.warn(<span class="hljs-string">&quot;消息 &#123;&#125; 被交换机 &#123;&#125; 退回，退回原因：&#123;&#125;，路由键：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(returned.getMessage().getBody()),<br>                returned.getExchange(), returned.getReplyText(), returned.getRoutingKey());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;publisherConfirmPlus&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">publisherConfirmPlus</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>(UUID.randomUUID().toString());<br>    rabbitTemplate.convertAndSend(RabbitConfig.PUBLISHER_CONFIRM_PLUS_EXCHANGE,<br>            RabbitConfig.PUBLISHER_CONFIRM_PLUS_QUEUE + <span class="hljs-string">&quot;_1&quot;</span>, RandomUtil.randomString(<span class="hljs-number">8</span>), correlationData);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>上面的例子中路由键不存在，消息发送后会有异常输入，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs log">c.z.j.rabbitmq.boot.callback.MyCallback  : 消息 fjutwwqj 被交换机 publisher_confirm_plus_exchange 退回，退回原因：NO_ROUTE，路由键：publisher_confirm_plus_queue_1<br></code></pre></td></tr></table></figure>
<h4 id="备份交换机"><a class="header-anchor" href="#备份交换机"></a>备份交换机</h4>
<p>当交换机异常时使用备份交换机来发送消息，同时还可以用备份交换机来记录本次异常日志</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/4ebbf38b4cc65e73d81f9e718cbf5a60.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>注册交换机并设置备份关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">publisherConfirmPlusExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(PUBLISHER_CONFIRM_PLUS_EXCHANGE)<br>            <span class="hljs-comment">// 设置备份交换机</span><br>            .withArgument(<span class="hljs-string">&quot;alternate-exchange&quot;</span>, PUBLISHER_CONFIRM_PLUS_BACKUP_EXCHANGE)<br>            .build();<br>&#125;<br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">publisherConfirmPlusBackupExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(PUBLISHER_CONFIRM_PLUS_BACKUP_EXCHANGE);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其他就是注册队列，并与交换机绑定</p>
<h3 id="其他知识"><a class="header-anchor" href="#其他知识"></a>其他知识</h3>
<h4 id="幂等性"><a class="header-anchor" href="#幂等性"></a>幂等性</h4>
<p>幂等性：用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用</p>
<p>消费端幂等性保障，主流有两种方式：</p>
<ul>
<li>唯一ID+指纹码机制，利用数据库去重</li>
<li>利用redis的原子性去实现（nx类命令）</li>
</ul>
<h4 id="优先级队列"><a class="header-anchor" href="#优先级队列"></a>优先级队列</h4>
<p>消费时先将队列按照优先级排列，即先消费优先级高的消息</p>
<p>优先级队列中优先级范围为<code>0~255</code>，越大优先级越高</p>
<h5 id="优先级队列使用注意事项"><a class="header-anchor" href="#优先级队列使用注意事项"></a>优先级队列使用注意事项</h5>
<ul>
<li>创建的队列需要通过<code>x-max-priority</code>设置最大优先级，不要设置太大，太大影响性能</li>
<li>发送的消息需要设置优先级（不设置的情况下，优先级是最低的），不能大于队列设置的最大优先级</li>
</ul>
<h4 id="惰性队列"><a class="header-anchor" href="#惰性队列"></a>惰性队列</h4>
<p>惰性队列：惰性队列会尽可能的将消息存入<strong>磁盘</strong>中，而在消费者消费到相应的消息时才会被加载到内存中，它的一个重要的设计目标是<strong>能够支持更长的队列</strong>，即支持更多的消息存储</p>
<p>默认情况下，生成发送到队列的消息是保存在内存中的，这样可以更快的发送消费者</p>
<h5 id="使用方式"><a class="header-anchor" href="#使用方式"></a>使用方式</h5>
<p>创建队列时设置<code>x-queue-mode</code>参数为<code>lazy</code>即可将队列设置为惰性队列</p>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/25392b0af493a8f5649a478cdcec1725.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h5 id="普通队列与惰性队列内存消耗对比"><a class="header-anchor" href="#普通队列与惰性队列内存消耗对比"></a>普通队列与惰性队列内存消耗对比</h5>
<p><img src="https://raw.gitmirror.com/zhuweitung/picbed/main/dc96dad16e8f463ddfc5e95cd72d8796.png" srcset="/img/loading.gif" lazyload alt=""></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/java/" class="category-chain-item">java</a>
  
  
    <span>></span>
    
  <a href="/categories/java/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="category-chain-item">消息队列</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java/">#java</a>
      
        <a href="/tags/RabbitMQ/">#RabbitMQ</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>RabbitMQ知识学习</div>
      <div>https://blog.kedr.cc/posts/1746580309/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>zhuweitung</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年1月13日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/3827541247/" title="SpringCloud知识学习">
                        <span class="hidden-mobile">SpringCloud知识学习</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"zhuweitung/zhuweitung.github.io","repo-id":"MDEwOlJlcG9zaXRvcnkzNjgxNjQ1MjM=","category":"Announcements","category-id":"DIC_kwDOFfG-q84CPNzk","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <script type="text/javascript" src="/js/cursor-effects.js"></script> <script color="0,0,0" opacity="0.5" zindex="-1" count="200" src="/js/canvas-nest.min.js"></script>
        </div>
      </div>
    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      浙ICP备2022018827号-1
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/custom.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
